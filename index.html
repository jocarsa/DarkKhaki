<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DarkKhaki</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        height: 100%;
        overflow: hidden;
        background: #f5f5f5;
    }

    /* Toolbar */
    #toolbar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        background: #333;
        color: #fff;
        display: flex;
        align-items: center;
        padding: 0 10px;
        z-index: 1000;
    }

    #toolbar button, #toolbar select, #toolbar input[type="color"] {
        margin-right: 10px;
        background: #444;
        border: none;
        color: #fff;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 14px;
    }

    #toolbar select {
        background: #444;
        color: #fff;
    }

    #toolbar button:hover, #toolbar select:hover {
        background: #555;
    }

    #toolbar input[type="color"] {
        width: 30px;
        height: 30px;
        padding: 0;
        outline: none;
        border: none;
        background: none;
        cursor: pointer;
    }

    #canvas-container {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        position: relative;
        top: 50px; /* Make room for the toolbar */
    }

    /* The transformable "canvas" */
    #pan-zoom-area {
        position: absolute;
        transform-origin: 0 0;
        cursor: grab;
        user-select: none;
    }

    .idea-tag {
        position: absolute;
        width: 150px;
        height: 80px;
        background: #eee;
        border-radius: 5px;
        padding: 5px;
        box-sizing: border-box;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: move;
        word-wrap: break-word;
        overflow: hidden;
        resize: none;
    }

    .text-content {
        width: 100%;
        height: 100%;
        outline: none;
        overflow: auto;
    }

    .idea-tag:focus {
        outline: none;
    }

    /* Resize handle */
    .resize-handle {
        width: 15px;
        height: 15px;
        position: absolute;
        right: 0;
        bottom: 0;
        cursor: nwse-resize;
        background: rgba(0,0,0,0.2);
        border-top-left-radius: 3px;
    }

    /* Tag Controls */
    .tag-controls {
        position: absolute;
        top: 5px;
        right: 5px;
        display: flex;
        gap: 5px;
    }

    .color-control, .delete-tag-btn, .format-btn, .font-size-select {
        background: rgba(255,255,255,0.7);
        border: none;
        cursor: pointer;
        font-size: 12px;
        padding: 2px 5px;
        border-radius: 3px;
        color: #000;
    }

    .color-control:hover, .delete-tag-btn:hover, .format-btn:hover, .font-size-select:hover {
        background: rgba(255,255,255,0.9);
    }

    .tag-color-picker {
        position: absolute;
        top: 25px;
        right: 5px;
        display: none;
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        padding: 0;
    }
</style>
</head>
<body>

<div id="toolbar">
    <select id="panel-select"></select>
    <button id="add-panel-btn">Add Panel</button>
    <button id="add-tag-btn">Add Idea Tag</button>
    <input type="color" id="tag-color-picker" value="#c0c0c0">
    <span style="color:#aaa;">
        Use mouse wheel or pinch-to-zoom. Drag background to pan. Drag corner to resize tags.
        Click Color on a tag to change its color. Click X to delete a tag.
        Use B, I, U, and font size to format selected text.
    </span>
</div>

<div id="canvas-container">
    <div id="pan-zoom-area"></div>
</div>

<script>
    const panZoomArea = document.getElementById('pan-zoom-area');
    const addTagBtn = document.getElementById('add-tag-btn');
    const addPanelBtn = document.getElementById('add-panel-btn');
    const tagColorPicker = document.getElementById('tag-color-picker');
    const panelSelect = document.getElementById('panel-select');

    let panels = {};  // { panelId: { name, originX, originY, scale, tags: [{html, left, top, width, height, color}] } }
    let currentPanelId = null;

    let scale = 1;
    let originX = 0;
    let originY = 0;
    let isPanning = false;
    let startX, startY;

    // ---- Panel Management ----

    function loadPanelsFromLocalStorage() {
        const savedData = localStorage.getItem('darkKhakiPanels');
        if (savedData) {
            panels = JSON.parse(savedData);
        } else {
            panels = {};
        }

        const lastPanelId = localStorage.getItem('darkKhakiLastPanelId');
        if (lastPanelId && panels[lastPanelId]) {
            currentPanelId = lastPanelId;
        } else {
            if (Object.keys(panels).length === 0) {
                currentPanelId = createPanel('Default Panel');
            } else {
                currentPanelId = Object.keys(panels)[0];
            }
        }
    }

    function savePanelsToLocalStorage() {
        localStorage.setItem('darkKhakiPanels', JSON.stringify(panels));
        localStorage.setItem('darkKhakiLastPanelId', currentPanelId);
    }

    function createPanel(name) {
        const panelId = 'panel_' + Date.now();
        panels[panelId] = {
            name: name,
            originX: 0,
            originY: 0,
            scale: 1,
            tags: []
        };
        savePanelsToLocalStorage();
        return panelId;
    }

    function updatePanelSelect() {
        panelSelect.innerHTML = '';
        for (const pid in panels) {
            const opt = document.createElement('option');
            opt.value = pid;
            opt.textContent = panels[pid].name;
            if (pid === currentPanelId) {
                opt.selected = true;
            }
            panelSelect.appendChild(opt);
        }
    }

    function loadPanel(panelId) {
        currentPanelId = panelId;
        const panel = panels[panelId];
        originX = panel.originX;
        originY = panel.originY;
        scale = panel.scale;
        applyTransform();
        panZoomArea.innerHTML = '';
        panel.tags.forEach(tagData => {
            const tag = createIdeaTag(
                tagData.html,
                tagData.color,
                tagData.left,
                tagData.top,
                tagData.width,
                tagData.height
            );
            panZoomArea.appendChild(tag);
        });
    }

    function saveCurrentPanel() {
        if (!currentPanelId) return;
        const panel = panels[currentPanelId];
        panel.originX = originX;
        panel.originY = originY;
        panel.scale = scale;

        const tagElements = panZoomArea.querySelectorAll('.idea-tag');
        panel.tags = Array.from(tagElements).map(tag => {
            const textEl = tag.querySelector('.text-content');
            return {
                html: textEl ? textEl.innerHTML : '',
                left: parseFloat(tag.style.left),
                top: parseFloat(tag.style.top),
                width: parseFloat(tag.style.width),
                height: parseFloat(tag.style.height),
                color: tag.style.backgroundColor
            };
        });

        savePanelsToLocalStorage();
    }

    // ---- Pan & Zoom Logic ----
    document.getElementById('canvas-container').addEventListener('mousedown', (e) => {
        if (e.target === panZoomArea || e.target.id === 'canvas-container') {
            isPanning = true;
            startX = e.clientX - originX;
            startY = e.clientY - originY;
            panZoomArea.style.cursor = 'grabbing';
        }
    });

    document.addEventListener('mouseup', () => {
        isPanning = false;
        panZoomArea.style.cursor = 'grab';
        saveCurrentPanel();
    });

    document.addEventListener('mousemove', (e) => {
        if (isPanning) {
            originX = e.clientX - startX;
            originY = e.clientY - startY;
            applyTransform();
        }
    });

    document.getElementById('canvas-container').addEventListener('wheel', (e) => {
        e.preventDefault();
        const zoomIntensity = 0.1;
        const direction = e.deltaY > 0 ? -1 : 1;
        const factor = (1 + zoomIntensity * direction);

        const rect = panZoomArea.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        originX = mouseX - (mouseX - originX) * factor;
        originY = mouseY - (mouseY - originY) * factor;

        scale *= factor;
        applyTransform();
        saveCurrentPanel();
    });

    function applyTransform() {
        panZoomArea.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
    }

    // ---- Idea Tag Management ----
    addTagBtn.addEventListener('click', () => {
        if (!currentPanelId) return;
        const tag = createIdeaTag('New Idea', tagColorPicker.value, originX + 50, originY + 50, 150, 80);
        panZoomArea.appendChild(tag);
        saveCurrentPanel();
    });

    function createIdeaTag(html, bgColor, left, top, width=150, height=80) {
        const tag = document.createElement('div');
        tag.className = 'idea-tag';
        tag.style.backgroundColor = bgColor;
        tag.style.left = left + 'px';
        tag.style.top = top + 'px';
        tag.style.width = width + 'px';
        tag.style.height = height + 'px';

        const textEl = document.createElement('div');
        textEl.className = 'text-content';
        textEl.contentEditable = "true";
        textEl.innerHTML = html;
        tag.appendChild(textEl);

        let isDragging = false;
        let dragStartX, dragStartY;

        tag.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('resize-handle') 
             || e.target.classList.contains('color-control') 
             || e.target.classList.contains('tag-color-picker') 
             || e.target.classList.contains('delete-tag-btn')
             || e.target.classList.contains('format-btn')
             || e.target.classList.contains('font-size-select')) return;

            if (e.target === tag || e.target === textEl) {
                isDragging = true;
                dragStartX = e.clientX - parseFloat(tag.style.left);
                dragStartY = e.clientY - parseFloat(tag.style.top);
                e.stopPropagation();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging || isResizing) {
                saveCurrentPanel();
            }
            isDragging = false;
            isResizing = false;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging && !isResizing) {
                const newX = e.clientX - dragStartX;
                const newY = e.clientY - dragStartY;
                tag.style.left = newX + 'px';
                tag.style.top = newY + 'px';
            }
            if (isResizing) {
                const dx = e.clientX - resizeStartX;
                const dy = e.clientY - resizeStartY;

                const newWidth = Math.max(50, resizeStartWidth + dx);
                const newHeight = Math.max(30, resizeStartHeight + dy);

                tag.style.width = newWidth + 'px';
                tag.style.height = newHeight + 'px';
            }
        });

        // On double click on text, select it
        textEl.addEventListener('dblclick', () => {
            const range = document.createRange();
            range.selectNodeContents(textEl);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        });

        // Resize handle logic
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        tag.appendChild(handle);

        let isResizing = false;
        let resizeStartX, resizeStartY, resizeStartWidth, resizeStartHeight;

        handle.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            isResizing = true;
            resizeStartX = e.clientX;
            resizeStartY = e.clientY;
            resizeStartWidth = parseFloat(getComputedStyle(tag, null).getPropertyValue('width'));
            resizeStartHeight = parseFloat(getComputedStyle(tag, null).getPropertyValue('height'));
        });

        // Tag Controls (Color, Delete, Format)
        const controlsContainer = document.createElement('div');
        controlsContainer.className = 'tag-controls';
        tag.appendChild(controlsContainer);

        // Color button
        const colorButton = document.createElement('button');
        colorButton.className = 'color-control';
        colorButton.textContent = 'Color';
        controlsContainer.appendChild(colorButton);

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.className = 'tag-color-picker';
        colorInput.value = bgColor;
        tag.appendChild(colorInput);

        let colorPickerVisible = false;
        colorButton.addEventListener('click', (e) => {
            e.stopPropagation();
            colorPickerVisible = !colorPickerVisible;
            colorInput.style.display = colorPickerVisible ? 'block' : 'none';
        });

        colorInput.addEventListener('input', () => {
            tag.style.backgroundColor = colorInput.value;
            saveCurrentPanel();
        });

        // Delete tag button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-tag-btn';
        deleteBtn.textContent = 'X';
        controlsContainer.appendChild(deleteBtn);
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            tag.remove();
            saveCurrentPanel();
        });

        // Formatting buttons
        const boldBtn = document.createElement('button');
        boldBtn.className = 'format-btn';
        boldBtn.textContent = 'B';
        boldBtn.style.fontWeight = 'bold';
        controlsContainer.appendChild(boldBtn);
        boldBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            textEl.focus();
            document.execCommand('bold', false, null);
            saveCurrentPanel();
        });

        const italicBtn = document.createElement('button');
        italicBtn.className = 'format-btn';
        italicBtn.textContent = 'I';
        italicBtn.style.fontStyle = 'italic';
        controlsContainer.appendChild(italicBtn);
        italicBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            textEl.focus();
            document.execCommand('italic', false, null);
            saveCurrentPanel();
        });

        const underlineBtn = document.createElement('button');
        underlineBtn.className = 'format-btn';
        underlineBtn.textContent = 'U';
        underlineBtn.style.textDecoration = 'underline';
        controlsContainer.appendChild(underlineBtn);
        underlineBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            textEl.focus();
            document.execCommand('underline', false, null);
            saveCurrentPanel();
        });

        // Font size selector (values: 1 to 7)
        const fontSizeSelect = document.createElement('select');
        fontSizeSelect.className = 'font-size-select';
        for (let i = 1; i <= 7; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = 'F' + i;
            fontSizeSelect.appendChild(opt);
        }
        controlsContainer.appendChild(fontSizeSelect);

        fontSizeSelect.addEventListener('change', (e) => {
            e.stopPropagation();
            textEl.focus();
            document.execCommand('fontSize', false, fontSizeSelect.value);
            saveCurrentPanel();
        });

        return tag;
    }

    // ---- Handle Panels ----
    addPanelBtn.addEventListener('click', () => {
        const panelName = prompt('Enter panel name:','New Panel');
        if (panelName) {
            const pid = createPanel(panelName);
            updatePanelSelect();
            loadPanel(pid);
        }
    });

    panelSelect.addEventListener('change', () => {
        const pid = panelSelect.value;
        if (panels[pid]) {
            saveCurrentPanel(); 
            loadPanel(pid);
            updatePanelSelect();
        }
    });

    loadPanelsFromLocalStorage();
    updatePanelSelect();
    loadPanel(currentPanelId);
</script>

</body>
</html>

